var bracket=function(){function escapeRegExp(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function extend(a){return each(slice.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a}function kvarg(a){var b={};return 2==a.length?(b[a[0]]=a[1],b):1==a.length?a[0]:void 0}function hash(a){var b={};return each(a,function(a){b[a]=!0}),b}function trace(a,b){a.__trace__={},each(a,function(c,d){_.isFun(d)&&(a.__trace__[c]=d,a[c]=function(){return console.log([c+":"].concat(slice.call(arguments))),b&&b.apply(this,arguments),a.__trace__[c].apply(this,arguments)})})}function copy(a){return _.isObj(a)?"length"in a?slice.call(a):values(a):a}function setdiff(a,b){var c=[];stain(b);for(var d=0,e=a.length;e>d;d++)isStained(a[d])?unstain(a[d]):c.push(a[d]);return c}function stain(a){_stainID++;for(var b=0,c=a.length;c>b;b++)a[b][_stainKey]=_stainID}function unstain(a){delete a[_stainKey]}function isStained(a){return a[_stainKey]==_stainID}function has(a,b){var e,c=arguments.length,d=1==c?a:b,f={};if(_.isArr(d)){var c=d.length;e=function(a){for(var b=0;c>b;b++)if(indexOf(a,d[b])>-1)return!0;return!1}}else e=function(a){return indexOf(a,d)>-1};return 2==c?(f={},f[a]=e,f):e}function find(){var b,c,d,e,f,g,h,a=slice.call(arguments),i=copy(_.isArr(this)?this:a.shift());for(2==a.length&&_.isStr(a[0])&&(d={},d[a[0]]=a[1],a=[d]),c=0;c<a.length;c++)if(b=a[c],_.isArr(b)){var j=[],k=i;if(0===b.length)i=k;else{if(!_.isObj(b[0])&&2==a.length){var l=a.pop();b=map(b,function(a){return obj(a,l)})}for(h=0;h<b.length;h++)console.log(h,j,JSON.stringify(k),i),j=j.concat(find(k,b[h])),k=setdiff(k,j);i=j,console.log(i)}}else if(_.isFun(b)){var m=b;for(f=i.length,h=f-1;h>=0;h--)d=i[h],m(d)&&(f-(h+1)&&(g=h+1,i.splice(g,f-g)),f=h);g=h+1,f-g&&i.splice(g,f-g)}else each(b,function(a,b){if(_.isObj(b)){var c=keys(b)[0],j=c.slice(1);if(!(j in bracket))throw new Error(j+" is an unknown function");b=bracket[j](b[c])}else _.isArr(b)&&(b=isin(b));if(_.isFun(b)){for(f=i.length,h=f-1;h>=0;h--)if(d=i[h],a in d){if(e=d[a],_.isFun(e)&&(e=e()),!b(e,d))continue;f-(h+1)&&(g=h+1,i.splice(g,f-g)),f=h}}else for(f=i.length,h=f-1;h>=0;h--)d=i[h],e=d[a],_.isFun(e)&&(e=e()),a in d&&e===b&&(f-(h+1)&&(g=h+1,i.splice(g,f-g)),f=h);g=h+1,f-g&&i.splice(g,f-g)});return i}function missing(a){var b=hash(a);return function(a){for(var c in b)if(c in a)return!1;return!0}}function isArray(a){var b=a.sort().join("");return function(a){return a.sort().join("")===b}}function like(a,b){var c,e,f,d=arguments.length,g={};return 1==d?e=a:2==d&&(e=b),e=e.toString(),c=function(a){if(null===a)return!1;try{f=new RegExp(e,"img")}catch(b){f=new RegExp(escapeRegExp(e),"img")}return a.toString().search(f)>-1},2==d?(g={},g[a]=c,g):c}function update(a,b){var c,d=this;return b!==_u&&(c=a,a={},a[c]=b),_.isFun(a)?each(d,a):each(a,function(a,b){_.isFun(b)?each(d,function(c){_.isFun(c[a])?c[a](b(c)):c[a]=b(c)}):each(d,function(c){_.isFun(c[a])?c[a](b):(console.log("here",a,b,c),c[a]=b)})}),this}function not(a){return function(){return!a.apply(this,arguments)}}function eachRun(a,b){var e,c=0,d=[];if(2==arguments.length?(e=a,a=b):e=this,_.isArr(a)&&2==a.length&&(c=a[0],a=a[1]),_.isArr(e))d=mapSoft(e,a);else{d={};for(var f in e)_.isFun(e[f])||(d[f]=a.call(c,e[f]))}return d}function chain(a){var b=(new bracket).concat(a);return b.chained=!0,b}function construct(a,b){function c(){return a.apply(this,b)}return c.prototype=a.prototype,new c}var _u,slice=Array.prototype.slice,arrify=function(a){return map(slice.call(a),function(a){return slice.call(a)})},toString=Object.prototype.toString,_stainID=0,_stainKey="_4ab92bf03191c585f182",_={isFun:function(a){return!!(a&&a.constructor&&a.call&&a.apply)},isStr:function(a){return!!(""===a||a&&a.charCodeAt&&a.substr)},isNum:function(a){return"[object Number]"===toString.call(a)},isArr:[].isArray||function(a){return"[object Array]"===toString.call(a)},isBool:function(a){return a===!0||a===!1||"[object Boolean]"==toString.call(a)},isObj:function(a){return _.isBool(a)||_.isFun(a)||_.isStr(a)||_.isNum(a)||_.isArr(a)?!1:null==a?"object"==String(a):"[object Object]"===toString.call(a)||!0}},proxy=function(a,b){return function(){b.apply(a,arguments)}},indexOf=[].indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=a.length-1;-1!=c&&b!=a[c];c--);return c},keys={}.keys||function(a){var b=[];for(var c in a)b.push(c);return b},values=function(a){var b=[];for(var c in a)b.push(a[c]);return b},obj=function(a,b){var c={};return c[a]=b,c},mapSoft=function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)c.push(b(a[d],d));return c},map=[].map?function(a,b){return a.map(b)}:mapSoft,each=[].forEach?function(a,b){if(_.isArr(a)){if(0===a.length)return;a.forEach(b)}else if(_.isStr(a)||_.isNum(a)||_.isBool(a))b(a);else for(var c in a)b(c,a[c])}:function(a,b){if(0!==a.length)if(_.isArr(a))for(var c=0,d=a.length;d>c;c++)b(a[c],c);else for(var e in a)b(e,a[e])},isin=function(a,b){var c,d=arguments.length,e=1==d?a:b||[],f=[],g=[],h={};if(!_.isArr(e))throw new TypeError("isin's argument is wrong. ",e);return e.length?(each(e,function(a){_.isFun(a)?f.push(a):g.push(a)}),c=function(a){for(var b=indexOf(g,a)>-1,c=0;c<f.length&&!b;c++)b=f[c](a);return b}):c=_.isFun(e)?function(a){return indexOf(e(),a)>-1}:e,2==d?(h={},h[a]=c,h):c},expression=function(a,b){var c,d;if(_.isStr(a)){if(d=a,1==arguments.length){try{c=new Function("x,rec","try { return x "+d+"} catch(e) {}")}catch(e){}if(!c)try{c=new Function("rec","try { return "+a+"} catch(e) {}")}catch(e){}}return 2==arguments.length&&_.isStr(b)&&(c={},d=b,c[a]=new Function("x,rec","try { return x "+d+"} catch(e) {}")),c}},bracket=function(a){if(1==arguments.length&&_.isStr(a))return expression.apply(this,arguments);if(!(this instanceof bracket))return construct(bracket,slice.call(arguments));var c=this;each({constraints:{addIf:[],unique:!1},chained:!1,syncList:[],syncLock:!1,length:0,_ix:{ins:0,del:0},_template:!1,_g:{}},function(a,b){Object.defineProperty(c,a,{value:b,writable:!0,configurable:!0,enumerable:!1})}),Object.defineProperty(this,"first",{get:function(){return this[0]}}),1==arguments.length?_.isArr(a)?this.insert(a):_.isFun(a)?this.insert(a()):_.isObj(a)&&this.insert(a):arguments.length>1&&this.insert(slice.call(arguments)),bracket.all.push(this)};return bracket.prototype=Object.create(Array.prototype),bracket.constructor=bracket,each({transaction_start:function(){this.syncLock=!0},transaction_end:function(){console.log("HHHHHH",this instanceof bracket),this.syncLock=!1,this.sync()},template_create:function(a){this._template=a},template_update:function(a){extend(this._template||{},a)},template_get:function(){return this._template},template_destroy:function(){this._template=!1},concat:function(){var a=new bracket;return a.splice.apply(a,Array.prototype.concat.apply([0,0],slice.call(this).concat(arrify(arguments)))),a},list2data:function(a){for(var b=[],c=0,d=a.length;d>c;c++)b[c]=this[a[c]];return b},schema:function(){for(var d,a={},b=this.length,c=Math.ceil(Math.min(10,b/3)),e=0;b>e;e+=c){d=this[e];for(var f in d)a[f]=_u}return keys(a)},constrain:function(){extend(this.constraints,kvarg(arguments))},addIf:function(a){return a&&this.constraints.addIf.push(a),this.constraints.addIf},beforeAdd:function(a){return this.addIf(a?function(){return a.apply(0,arguments),!0}:!1)},unset:function(a){if(_.isArr(a)){var b=this,c=arguments.callee;return each(a,function(){return c.apply(b,arguments)})}return each(this,function(b,c){a in c&&delete c[a]}),this.sync(),this},each:eachRun,map:eachRun,not:not,findFirst:function(){var a=this.find.apply(this,arguments);return a.length?a[0]:!1},has:has,hasKey:function(){var a=this.find(missing(slice.call(arguments)));return this.invert(a,this)},isin:isin,like:like,invertArray:function(a,b){return setdiff(b||this,a||this)},invert:function(a,b){return chain(this.invertArray(a,b))},missing:function(){var a=missing(slice.call(arguments));return this.chained?this.find(a):a},sync:function(a){if(a)this.syncList.push(a);else if(!this.syncLock){this.syncLock=!0;var b=this;each(this.syncList,function(a){a.call(b,b)}),this.syncLock=!1}return this},update:function(){var a=update.apply(this,arguments);return this.sync(),a},group:function(a){var b={};return each(this,function(c){a in c&&each(c[a],function(a){a in b||(b[a]=chain([])),b[a].push(c)})}),b},keyBy:function(){var b=this.group.apply(this,arguments);return each(b,function(a,c){b[a]=c[0]}),b},indexBy:function(){this.splice.apply(this,[0,0].concat(this.order.apply(this,arguments)))},order:function(arg0,arg1){var key,fnSort,len=arguments.length,order;return _.isFun(arg0)?fnSort=arg0:_.isStr(arg0)&&(key=arg0,1==len?order="x-y":2==len&&(order=_.isStr(arg1)?{asc:"x-y",desc:"y-x"}[arg1.toLowerCase()]:arg1),_.isStr(order)&&(order=new Function("x,y","return "+order)),eval("fnSort=function(a,b){return order(a."+key+", b."+key+")}")),chain(Array.prototype.sort.call(this,fnSort))},where:function(){var a=slice.call(arguments);return _.isArr(this)||(a=[this].concat(a)),chain(find.apply(this,a))},lazyView:function(field,type){function update(a){if(a){if("del"==a&&myix.del==mthis._ix.del)return;if("ins"==a&&myix.ins==mthis._ix.ins)return}myix={del:mthis._ix.del,ins:mthis._ix.ins};var b={};each(mthis,function(a){keyer(a,b)});for(var c in update)c in b||delete update[c]}var mthis=this,myix={del:this._ix.del,ins:this._ix.ins},keyer;return-1==field.search(/[()]/)?(("["!==field.charAt(0)||"."!==field.charAt(0))&&(field="."+field),eval("keyer = function(r,ref){try{ref[rX] = update[rX] = r;} catch(x){}}".replace(/X/g,field))):(console.log("keyer = function(r,ref){with(r) { var val = X };try{ref[val] = update[val] = r;} catch(x){}}".replace(/X/g,field)),eval("keyer = function(r,ref){try{ with(r) { var val = X }; ref[val] = update[val] = r;} catch(x){}}".replace(/X/g,field))),update(),update},view:function(a,b){var c=this.lazyView(a,b);return this.sync(c),c},select:function(a){var c,b=this,d={};return arguments.length>1?a=slice.call(arguments):_.isStr(a)&&(a=[a]),c=a.length,each(a,function(a,e){if("*"==a)d=map(b,values);else for(var f=0,g=b.length;g>f;f++)row=b[f],a in row&&(c>1?(d[f]||(d[f]=[]),d[f][e]=row[a]):d[f]=row[a])}),chain(values(d))},insert:function(a){var c,b=this,d=this.constraints.unique,e=[],f=[],g=[];return f=arguments.length>1?slice.call(arguments):_.isArr(a)?a:[a],each(f,function(a){var f=!0;if(d&&d in a){var j,i="c-"+d;b._g[i]?b._g[i]("del"):b._g[i]=b.lazyView(d),j=b._g[i],a[d]in j?(e.push(j[a[d]]),g.push(j[a[d]]),f=!1):j[a[d]]=a}if(each(b.constraints.addIf,function(b){f&=b(a)}),f){if(b._ix.ins++,c=b.length,b._template){var k={};each(b._template,function(a,b){k[a]=_.isFun(b)?b():b}),a=extend(k,a)}b.push(a),g.push(c)}}),this.sync(),this},flash:function(a){this.splice.apply(this,[0,0].concat(a))},remove:function(a){var d,e,f,c=!1,g=[];if(_.isArr(this))f=this;else if(_.isArr(a))f=a;else{if(arguments.length>0)return g=this.find.apply(this,arguments),g.length&&(this.splice.apply(this,[0,this.length].concat(this.invertArray(g))),this._ix.del++,this.sync()),chain(g.reverse());f=this.find()}stain(f);for(var h=this.length-1,d=this.length;h>=0;h--)isStained(this[h])?(unstain(this[h]),g.push(this[h])):(d-(h+1)&&(e=h+1,this.splice(e,d-e),c=!0),d=h);return e=h+1,d-e&&(this.splice(e,d-e),c=!0),c&&(this._ix.del++,this.sync()),chain(g.reverse())}},function(a,b){Object.defineProperty(bracket.prototype,a,{value:b,configurable:!0,writable:!0})}),each({sort:bracket.prototype.order,orderBy:bracket.prototype.sort,find:bracket.prototype.where},function(a,b){Object.defineProperty(bracket.prototype,a,{value:b,configurable:!0,writable:!0})}),extend(bracket,{all:[],find:find,diff:setdiff,each:eachRun,not:not,exec:expression,like:like,trace:trace,values:values,isin:isin,isArray:isArray,local:function(){return"(function(){ return "+bracket.apply(this,arguments).toString()+";})()"},copy:function(a){return map(a,function(a){return copy(a)})},objectify:function(a,b){var c=[];return each(b,function(b){var d={};each(a,function(a,c){d[a]=b[c]}),c.push(d)}),c},findFirst:function(){var a=find.apply(this,arguments);return a.length?a[0]:{}},reduceLeft:function(a,b){var c=_.isStr(b)?new Function("y,x","return y "+b):b;return function(b){for(var d=a,e=0,f=b.length;f>e;e++)b[e]&&(d=c(d,b[e]));return d}},reduceRight:function(a,b){var b=bracket.reduceLeft(a,b);return function(a){return b(a.reverse())}}}),bracket}();